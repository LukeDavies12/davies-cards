-- ================================
-- TEAM
-- ================================
CREATE TABLE team (
  team_id SERIAL PRIMARY KEY,
  team_name VARCHAR(1000) NOT NULL,
  team_city VARCHAR(1000) NOT NULL,
  team_state CHAR(2) NOT NULL,
  team_created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  team_level VARCHAR(1000)
);

-- ================================
-- TEAM_QB
-- ================================
CREATE TABLE team_qb (
  team_qb_id SERIAL PRIMARY KEY,
  team_id INT NOT NULL REFERENCES team(team_id) ON DELETE RESTRICT,
  qb_name VARCHAR(1000) NOT NULL,
  qb_number INT NOT NULL
);

-- ================================
-- SEASON
-- ================================
CREATE TABLE season (
  season_id SERIAL PRIMARY KEY,
  team_id INT NOT NULL REFERENCES team(team_id) ON DELETE RESTRICT,
  season_year INT NOT NULL,
  season_fall_bit BIT NOT NULL DEFAULT TRUE
);

-- ================================
-- SEASON_QB
-- ================================
CREATE TABLE season_qb (
  season_qb_id SERIAL PRIMARY KEY,
  season_id INT NOT NULL REFERENCES season(season_id) ON DELETE RESTRICT,
  team_qb_id INT NOT NULL REFERENCES team_qb(team_qb_id),
  season_qb_year_class VARCHAR(1000),
  season_qb_is_starter BOOLEAN NOT NULL DEFAULT false
);

-- ================================
-- GAME
-- ================================
CREATE TABLE game (
  game_id SERIAL PRIMARY KEY,
  season_id INT NOT NULL REFERENCES season(season_id) ON DELETE RESTRICT,
  game_date DATE NOT NULL,
  game_opponent VARCHAR(1000) NOT NULL
);

-- ================================
-- DRIVE
-- ================================
CREATE TABLE drive (
  drive_id SERIAL PRIMARY KEY,
  game_id INT NOT NULL REFERENCES game(game_id) ON DELETE RESTRICT,
  drive_number_in_game INT NOT NULL
);

-- ================================
-- PLAY_GROUPING (concept group)
-- ================================
CREATE TABLE play_grouping (
  play_grouping_id SERIAL PRIMARY KEY,
  team_id INT NOT NULL REFERENCES team(team_id) ON DELETE RESTRICT,
  play_grouping_name VARCHAR NOT NULL,
  play_grouping_type VARCHAR NOT NULL,
  UNIQUE(team_id, grouping_name)
);

-- ================================
-- PLAY
-- ================================
CREATE TABLE play (
  play_id                  SERIAL PRIMARY KEY,
  drive_id                 INT NOT NULL REFERENCES drive(drive_id) ON DELETE RESTRICT,
  film_number              INT NOT NULL,
  season_qb_id             INT NOT NULL REFERENCES season_qb(season_qb_id),
  yard_line                INT NOT NULL,
  down_number              INT NOT NULL,
  distance_to_go           INT NOT NULL,
  play_grouping_id         INT NOT NULL REFERENCES play_grouping(play_grouping_id),
  play_call                VARCHAR NOT NULL,
  play_call_tags           TEXT,
  yards_gained             INT NOT NULL,
  play_result              VARCHAR NOT NULL,
  sack_on_qb               BOOLEAN DEFAULT false,
  rpo_read_keys            BOOLEAN DEFAULT false,
  read_option_read_keys    BOOLEAN DEFAULT false,
  pocket_presence          VARCHAR,
  pass_read                VARCHAR,
  pass_ball_placement      VARCHAR,
  scramble_execution       VARCHAR,
  qb_run_execution         VARCHAR,
  audible_opp_missed       BOOLEAN DEFAULT false,
  audible_called           BOOLEAN DEFAULT false,
  audible_success          BOOLEAN DEFAULT false,
  notes                    TEXT,
  created_at               TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ================================
-- TAG
-- ================================
CREATE TABLE tag (
  tag_id       SERIAL PRIMARY KEY,
  team_id      INT NOT NULL REFERENCES team(team_id) ON DELETE RESTRICT,
  tag_name     VARCHAR NOT NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(team_id, tag_name)
);

-- ================================
-- PLAY_TAG (many-to-many)
-- ================================
CREATE TABLE play_tag (
  play_id      INT NOT NULL REFERENCES play(play_id) ON DELETE RESTRICT,
  tag_id       INT NOT NULL REFERENCES tag(tag_id) ON DELETE RESTRICT,
  PRIMARY KEY (play_id, tag_id)
);

-- ================================
-- PRACTICE_ON_GAME
-- ================================
CREATE TABLE practice_on_game (
  practice_on_game_id SERIAL PRIMARY KEY,
  game_id             INT NOT NULL REFERENCES game(game_id) ON DELETE RESTRICT,
  practice_date       DATE NOT NULL,
  created_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ================================
-- PRACTICE_BLOCK
-- ================================
CREATE TABLE practice_block (
  practice_block_id   SERIAL PRIMARY KEY,
  practice_on_game_id INT NOT NULL REFERENCES practice_on_game(practice_on_game_id) ON DELETE RESTRICT,
  block_name          VARCHAR NOT NULL,
  created_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ================================
-- PRACTICE_PLAY
-- ================================
CREATE TABLE practice_play (
  practice_play_id     SERIAL PRIMARY KEY,
  practice_block_id    INT NOT NULL REFERENCES practice_block(practice_block_id) ON DELETE RESTRICT,
  film_number          INT NOT NULL,
  season_qb_id         INT NOT NULL REFERENCES season_qb(season_qb_id),
  play_grouping_id     INT NOT NULL REFERENCES play_grouping(play_grouping_id),
  play_call            VARCHAR NOT NULL,
  play_call_tags       TEXT,
  yards_gained         INT NOT NULL,
  play_result          VARCHAR NOT NULL,
  sack_on_qb           BOOLEAN DEFAULT false,
  rpo_read_keys        BOOLEAN DEFAULT false,
  read_option_read_keys BOOLEAN DEFAULT false,
  pocket_presence      VARCHAR,
  pass_read            VARCHAR,
  pass_ball_placement  VARCHAR,
  scramble_execution   VARCHAR,
  qb_run_execution     VARCHAR,
  audible_opp_missed   BOOLEAN DEFAULT false,
  audible_called       BOOLEAN DEFAULT false,
  audible_success      BOOLEAN DEFAULT false,
  notes                TEXT,
  created_at           TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ================================
-- INVITE
-- ================================
CREATE TABLE invite (
  invite_id       SERIAL PRIMARY KEY,
  email           VARCHAR NOT NULL,
  display_name    VARCHAR,
  team_id         INT NOT NULL REFERENCES team(team_id) ON DELETE RESTRICT,
  season_id       INT REFERENCES season(season_id),
  job_title       VARCHAR NOT NULL,
  role            VARCHAR NOT NULL,
  status          VARCHAR NOT NULL,
  token           VARCHAR NOT NULL,
  expires_at      TIMESTAMPTZ NOT NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ================================
-- USER
-- ================================
CREATE TABLE app_user (
  user_id          SERIAL PRIMARY KEY,
  email            VARCHAR NOT NULL UNIQUE,
  password_hash    VARCHAR NOT NULL,
  display_name     VARCHAR,
  job_title        VARCHAR NOT NULL,
  team_id          INT REFERENCES team(team_id),
  season_id        INT REFERENCES season(season_id),
  role             VARCHAR NOT NULL,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ================================
-- SESSION
-- ================================
CREATE TABLE session (
  session_id VARCHAR PRIMARY KEY,
  user_id INT NOT NULL REFERENCES app_user(user_id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at TIMESTAMPTZ NOT NULL
);
